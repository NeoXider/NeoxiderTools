# Менеджер Уровней (LevelManager)

## 1. Введение

`LevelManager` — это централизованный компонент (Singleton) для управления логикой уровней и карт в игре. Он позволяет создавать несколько "карт", каждая из которых содержит свое количество уровней и прогресс. Менеджер отслеживает текущий выбранный уровень, максимальный доступный уровень на карте, а также автоматически сохраняет и загружает прогресс игрока.

Компонент тесно интегрирован с `LevelButton` для автоматического отображения и обновления состояния кнопок выбора уровня на UI.

---

## 2. Описание класса

### LevelManager
- **Пространство имен**: `Neo.Level`
- **Путь к файлу**: `Assets/Neoxider/Scripts/Level/LevelManager.cs`
- **Наследуется от**: `Singleton<LevelManager>`

**Описание**:
Синглтон для управления прогрессом уровней, картами и их визуальным представлением.

### Ключевые особенности
- **Синглтон**: Легкий доступ к экземпляру класса из любой точки кода через `LevelManager.I`.
- **Система карт**: Позволяет группировать уровни в карты, каждая со своим прогрессом.
- **Сохранение и загрузка**: Автоматически сохраняет и загружает прогресс прохождения уровней для каждой карты с помощью `PlayerPrefs`.
- **Автоматическое обновление UI**: Автоматически находит и обновляет компоненты `LevelButton`, отображая их статус (пройден, текущий, заблокирован).
- **Гибкая логика уровней**: Поддерживает как конечные, так и бесконечные и зацикленные уровни.

---

## 3. Настройки в инспекторе

- `_saveKey` (`string`): Базовый ключ, по которому будет сохраняться прогресс в `PlayerPrefs`.
- `_currentLevel` (`int`): Текущий выбранный уровень (индекс).
- `_maps` (`Map[]`): Массив карт, каждая из которых содержит свои настройки уровней.
- `_lvlBtns` (`LevelButton[]`): Массив кнопок уровней. **Заполняется автоматически**, если указано поле `_parentLevel`.
- `_mapId` (`int`): ID текущей выбранной карты.
- `_onAwakeNextLevel` (`bool`): Если `true`, при старте будет автоматически выбран последний доступный уровень.
- `_onAwakeNextMap` (`bool`): Если `true`, при старте будет автоматически выбрана последняя доступная карта.
- `_parentLevel` (`Transform`): Родительский объект, содержащий кнопки уровней. Используется для автоматического поиска и заполнения массива `_lvlBtns`.

---

## 4. Публичные свойства

- `MaxLevel` (`int`): Максимальный пройденный уровень на текущей карте. Только для чтения.
- `MapId` (`int`): ID текущей карты. Только для чтения.
- `CurrentLevel` (`int`): Текущий выбранный уровень. Только для чтения.
- `Map` (`Map`): Экземпляр текущей выбранной карты. Только для чтения.

---

## 5. Публичные методы

- `SetLastMap()`: Выбирает последнюю доступную (не полностью пройденную) карту.
- `GetLastIdMap()`: Возвращает ID последней доступной карты.
- `GetLastLevelId()`: Возвращает ID последнего доступного уровня на текущей карте.
- `SetMapId(int id)`: Устанавливает текущую карту по ее ID.
- `NextLevel()`: Переключается на следующий уровень.
- `SetLastLevel()`: Выбирает последний доступный уровень на текущей карте.
- `Restart()`: "Перезапускает" текущий уровень (повторно вызывает `SetLevel` с тем же ID).
- `SaveLevel()`: Сохраняет прогресс, если текущий выбранный уровень является последним доступным.
- `SetLevel(int idLevel)`: Устанавливает текущий уровень по его ID.

---

## 6. Unity Events

- `OnChangeLevel`: Вызывается при изменении `CurrentLevel`. Передает `int` (новый ID уровня).
- `OnChangeMap`: Вызывается при изменении `MapId`. Передает `int` (новый ID карты).
- `OnChangeMaxLevel`: Вызывается при сохранении нового максимального уровня. Передает `int` (новый максимальный уровень).
