# Компонент VisualToggle

## 1. Введение

`VisualToggle` — это универсальный компонент для переключения между двумя визуальными состояниями с поддержкой множественных элементов. Компонент может работать автономно или автоматически интегрироваться с компонентом `Toggle`.

Он идеально подходит для любых элементов, у которых есть два четких состояния: кнопка "включено/выключено", звук "вкл/выкл", выбранный и невыбранный элемент и т.д.

---

## 2. Описание класса

### VisualToggle
- **Пространство имен**: `Neo.UI`
- **Путь к файлу**: `Assets/Neoxider/Scripts/UI/View/VisualToggle.cs`

**Описание**
Универсальный компонент для управления переключением между двумя предопределенными визуальными состояниями (`start` и `end`) на основе `bool` флага. Поддерживает одновременное управление множеством Image (спрайты и цвета), TextMeshPro (цвета и текст) и GameObject'ов.

**Ключевые особенности**
- **Два состояния**: Четко разделяет визуал на "начальный" (start) и "конечный" (end).
- **Универсальность**: Может изменять спрайты, цвета, текст и активность множества `GameObject`'ов одновременно.
- **Гибкое управление**: Состояние переключается через `bool` свойство `IsActive` или вызовом методов.
- **Интеграция с Toggle**: Автоматически подписывается на события `Toggle` при наличии компонента (опционально).
- **UnityEvent события**: Предоставляет `On`, `Off` и `OnValueChanged` для интеграции с другими системами.
- **Кнопки в Inspector**: Поддерживает кнопки для тестирования через атрибут `[Button]`.
- **setOnAwake**: Опция для автоматического вызова событий текущего состояния при старте.

---

## 3. Публичные свойства

### IsActive
```csharp
public bool IsActive { get; private set; }
```
Текущее состояние переключателя.
- `true` — активное состояние (end)
- `false` — неактивное состояние (start)

При изменении автоматически обновляет визуал и вызывает события.

---

## 4. Настройки компонента

### setOnAwake
```csharp
[SerializeField] private bool _setOnAwake;
```
Если включено, вызывает события текущего состояния при старте (Start). Полезно для инициализации связанных систем в соответствии с начальным состоянием переключателя.

**Пример использования:**
- Если переключатель в начальном состоянии (IsActive = false) и `setOnAwake = true`, при старте будет вызван `Off` event
- Если переключатель в активном состоянии (IsActive = true) и `setOnAwake = true`, при старте будет вызван `On` event
- Также будет вызван `OnValueChanged` с текущим значением

Это особенно полезно для синхронизации других систем с начальным состоянием переключателя без необходимости дополнительного кода.

---

## 5. Публичные методы

### Toggle()
```csharp
public void Toggle()
```
Инвертирует текущее состояние переключателя. Доступна кнопка в Inspector.

### SetActive()
```csharp
public void SetActive()
```
Устанавливает состояние в активное (end) и обновляет визуал.

### SetInactive()
```csharp
public void SetInactive()
```
Устанавливает состояние в неактивное (start) и обновляет визуал.

### SetActive(bool, bool)
```csharp
public void SetActive(bool isActive, bool invokeToggleEvent = false)
```
Устанавливает указанное состояние переключателя.

**Параметры:**
- `isActive` — `true` для активного состояния (end), `false` для неактивного (start)
- `invokeToggleEvent` — Если `true` и есть `Toggle`, вызовет его событие `onValueChanged`. По умолчанию `false`.

Доступна кнопка в Inspector для тестирования.

### UpdateVisuals()
```csharp
public void UpdateVisuals()
```
Принудительно обновляет все визуальные элементы в соответствии с текущим состоянием.

---

## 6. UnityEvent события

### On
```csharp
public UnityEvent On;
```
Вызывается при переходе в активное состояние (end).

### Off
```csharp
public UnityEvent Off;
```
Вызывается при переходе в неактивное состояние (start).

### OnValueChanged
```csharp
public UnityEvent<bool> OnValueChanged;
```
Вызывается при любом изменении состояния. Передает новое значение (`true` = активен).

---

## 7. Настройка визуальных элементов

### ImageVariant
Класс для настройки переключения спрайтов Image между состояниями.

**Поля:**
- `image` — Image компонент для переключения спрайта
- `start` — Спрайт для начального состояния (start)
- `end` — Спрайт для конечного состояния (end)
- `setNativeSize` — Автоматически устанавливать размер Image по размеру спрайта

**Использование:**
```csharp
// В Inspector настройте массив imageV:
// imageV[0]:
//   - image: ссылка на Image компонент
//   - start: спрайт для неактивного состояния
//   - end: спрайт для активного состояния
//   - setNativeSize: true/false
```

### ImageColor
Класс для настройки переключения цветов Image между состояниями.

**Поля:**
- `image` — Image компонент для переключения цвета
- `start` — Цвет для начального состояния (start)
- `end` — Цвет для конечного состояния (end)

**Использование:**
```csharp
// В Inspector настройте массив imageC:
// imageC[0]:
//   - image: ссылка на Image компонент
//   - start: Color.white (неактивное состояние)
//   - end: Color.green (активное состояние)
```

### TmpColorTextVariant
Класс для настройки переключения цветов и/или текста TextMeshPro между состояниями.

**Поля:**
- `tmp` — TextMeshPro компонент для переключения
- `start` — Цвет для начального состояния (start)
- `end` — Цвет для конечного состояния (end)
- `useText` — Переключать ли текст вместе с цветом
- `startText` — Текст для начального состояния (используется только если `useText = true`)
- `endText` — Текст для конечного состояния (используется только если `useText = true`)

**Использование:**
```csharp
// В Inspector настройте массив textColor:
// textColor[0]:
//   - tmp: ссылка на TextMeshProUGUI
//   - start: Color.gray
//   - end: Color.white
//   - useText: true
//   - startText: "Выключено"
//   - endText: "Включено"
```

### GameObjectVariant
Класс для настройки переключения активности групп GameObject'ов между состояниями.

**Поля:**
- `starts` — Массив GameObject'ов, которые активны в начальном состоянии (start)
- `ends` — Массив GameObject'ов, которые активны в конечном состоянии (end)

**Использование:**
```csharp
// В Inspector настройте variants:
// variants:
//   - starts: [GameObject1, GameObject2] // Активны когда IsActive = false
//   - ends: [GameObject3, GameObject4]   // Активны когда IsActive = true
```

---

## 8. Интеграция с Toggle

Компонент автоматически интегрируется с `Toggle` при наличии:

1. **Автоматическое обнаружение**: Использует атрибут `[GetComponent]` для автоматического поиска `Toggle` на том же GameObject
2. **Подписка на события**: Автоматически подписывается на `onValueChanged` события `Toggle`
3. **Синхронизация состояния**: Состояние `VisualToggle` синхронизируется с состоянием `Toggle`
4. **Защита от рекурсии**: Предотвращает бесконечные циклы при взаимном обновлении

**Работа без Toggle:**
Компонент может работать полностью автономно, управляя состоянием через код или Inspector.

---

## 9. Примеры использования

### Пример 1: Кнопка "Звук вкл/выкл"

```csharp
// Настройка в Inspector:
// - imageV[0]: Image с иконкой звука (start = вкл, end = выкл)
// - imageC[0]: Фон кнопки (start = зеленый, end = красный)
// - textColor[0]: Текст "Звук" (start = белый, end = серый)
// - On: Подключить к AudioListener.volume = 1
// - Off: Подключить к AudioListener.volume = 0

// Использование:
visualToggle.Toggle(); // Переключить состояние
```

### Пример 2: Переключатель через код

```csharp
public class SettingsManager : MonoBehaviour
{
    [SerializeField] private VisualToggle soundToggle;
    
    private void Start()
    {
        // Установить начальное состояние
        bool soundEnabled = PlayerPrefs.GetInt("SoundEnabled", 1) == 1;
        soundToggle.SetActive(soundEnabled);
        
        // Подписаться на изменения
        soundToggle.OnValueChanged.AddListener(OnSoundToggled);
    }
    
    private void OnSoundToggled(bool isEnabled)
    {
        PlayerPrefs.SetInt("SoundEnabled", isEnabled ? 1 : 0);
        AudioListener.volume = isEnabled ? 1f : 0f;
    }
}
```

### Пример 3: Комплексный переключатель с множеством элементов

```csharp
// Настройка в Inspector для сложного переключателя персонажа:
// - imageV[0]: Иконка персонажа (start = серая, end = цветная)
// - imageV[1]: Фон карточки (start = прозрачный, end = выделенный)
// - imageC[0]: Рамка (start = серый, end = золотой)
// - textColor[0]: Имя персонажа (start = серый, end = белый)
// - textColor[1]: Текст "Выбрано" (useText = true, startText = "", endText = "Выбрано")
// - variants.starts: [галочка выбора]
// - variants.ends: [галочка выбора, эффекты вокруг]
// - On: Подключить к выбору персонажа в игре
```

### Пример 4: Интеграция с Toggle

```csharp
// Просто добавьте Toggle на тот же GameObject, что и VisualToggle
// Компонент автоматически:
// - Найдет Toggle
// - Подпишется на его события
// - Будет синхронизировать состояние

// Можно также управлять программно:
visualToggle.SetActive(true); // Установит состояние и обновит Toggle
```

---

## 10. Автоматическое сохранение начальных значений

В методе `OnValidate()` компонент автоматически сохраняет текущие значения как начальные (start) когда состояние находится в неактивном положении:

- Для `ImageVariant`: сохраняет текущий спрайт как `start` если он не задан
- Для `TmpColorTextVariant`: сохраняет текущий цвет и текст как `start` если они не заданы

Это упрощает настройку — просто установите нужный визуал в Inspector и компонент автоматически сохранит его как начальное состояние.

---

## 11. Рекомендации

1. **Используйте один компонент на GameObject**: Для одного переключателя используйте один `VisualToggle`
2. **Группируйте элементы**: Используйте массивы для управления множеством похожих элементов
3. **Автоматическое сохранение**: Используйте автоматическое сохранение начальных значений в `OnValidate()`
4. **Интеграция с Toggle**: Добавляйте `Toggle` только если нужна стандартная логика переключателя Unity
5. **События**: Используйте UnityEvent для интеграции с другими системами без кода

---

## 12. Отличия от других компонентов

- **VariantView**: Управляет состояниями по индексу (0, 1, 2, ...), `VisualToggle` — только два состояния (start/end)
- **ToggleView** (удален): `VisualToggle` заменяет его, предоставляя все возможности и больше

---

## 13. Технические детали

- **Производительность**: Обновление визуала происходит только при изменении состояния
- **Защита от рекурсии**: Использует флаг `_isUpdatingFromToggle` для предотвращения бесконечных циклов
- **Null-проверки**: Все методы безопасно обрабатывают `null` ссылки
- **Editor-поддержка**: Полностью интегрирован с Unity Inspector, включая кнопки для тестирования

---

## 14. Версия

Текущая версия компонента: 2.0 (объединенная версия с возможностями ToggleView)
