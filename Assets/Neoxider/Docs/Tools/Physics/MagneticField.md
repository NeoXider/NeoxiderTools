# MagneticField

Магнитное поле, которое притягивает или отталкивает объекты в радиусе. Идеально подходит для создания магнитных эффектов, сбора предметов, защитных полей и других интерактивных элементов.

## Возможности

- Притяжение или отталкивание объектов в радиусе
- Постоянное воздействие на объекты
- Фильтрация по слоям
- Опциональное добавление Rigidbody
- Затухание силы по расстоянию
- Режимы: притяжение, отталкивание, к цели/точке, по направлению
- **Toggle** — опциональная галочка, работает с любым режимом: сначала в одну сторону, потом в обратную
- События при входе/выходе объектов и при переключении Toggle

## Настройки

### Настройки поля

- **Mode**: Режим работы поля
  - `Attract` - притяжение объектов к себе
  - `Repel` - отталкивание объектов
  - `ToTarget` - притяжение к Transform цели
  - `ToPoint` - притяжение к точке в пространстве
  - `Direction` - притяжение по направлению (вектор)
- **Field Strength**: Сила магнитного поля
- **Radius**: Радиус действия поля
- **Falloff Type**: Тип затухания силы по расстоянию
  - `Linear` - линейное затухание
  - `Quadratic` - квадратичное затухание
  - `Constant` - без затухания

### Toggle (переключение направления)

Опциональная галочка `_toggle` (по умолчанию выключена). Работает **с любым режимом**: Attract, Repel, ToTarget, ToPoint, Direction. Когда включена — поле сначала действует в прямом направлении, потом в обратном, и так циклически.

- **Toggle** (`bool`): Включить переключение направления (по умолчанию `false`)
- **Attract Duration**: Время действия в прямом направлении (секунды)
- **Repel Duration**: Время действия в обратном направлении (секунды)
- **Start With Attract**: Начинать с прямого направления (`true`) или с обратного (`false`)

Примеры:
- `Attract` + Toggle → притяжение, потом отталкивание, потом притяжение...
- `Repel` + Toggle → отталкивание, потом притяжение, потом отталкивание...
- `ToTarget` + Toggle → притяжение к цели, потом отталкивание от цели...
- `Direction` + Toggle → сила по направлению, потом в обратную сторону...

### Цель притяжения

- **Target Transform**: Transform цели (используется при режиме ToTarget)
- **Target Point**: Точка в пространстве (используется при режиме ToPoint)

### Направление притяжения (Direction)

- **Direction**: Вектор направления (используется при режиме Direction)
- **Direction Is Local**: Если включено — Direction задаётся в локальных координатах объекта
- **Direction Gizmo Distance**: Длина визуализации направления в сцене (и точка‑ручка для редактирования)

### Фильтрация

- **Affected Layers**: Слои объектов, на которые будет воздействовать поле

### Опции

- **Add Rigidbody If Needed**: Автоматически добавлять Rigidbody на объекты без физики
- **Use Fixed Update**: Использовать FixedUpdate вместо Update для более стабильной физики
- **Update Interval**: Интервал обновления объектов в поле (0 = каждый кадр)

## События

- **OnObjectEntered**: Вызывается при входе объекта в поле (GameObject)
- **OnObjectExited**: Вызывается при выходе объекта из поля (GameObject)
- **OnModeChanged**: Вызывается при переключении Toggle (bool: true = прямое направление, false = обратное)

## API

### Методы

```csharp
// Переключить режим поля (Attract/Repel)
void ToggleMode()

// Установить режим поля
void SetMode(FieldMode newMode)

// Установить силу поля
void SetStrength(float newStrength)

// Установить радиус поля
void SetRadius(float newRadius)

// Установить цель притяжения (Transform)
void SetTarget(Transform target)

// Установить точку притяжения
void SetTargetPoint(Vector3 point)

// Установить направление притяжения (вектор)
void SetDirection(Vector3 newDirection, bool local = true)

// Установить время прямого направления для Toggle
void SetAttractDuration(float duration)

// Установить время обратного направления для Toggle
void SetRepelDuration(float duration)

// Сбросить таймер Toggle (начать цикл заново)
void ResetToggleTimer()
```

### Свойства

```csharp
// Текущая сила поля
float CurrentStrength { get; }

// Текущий радиус поля
float CurrentRadius { get; }

// Количество объектов в поле
int ObjectsInFieldCount { get; }

// Текущее состояние Toggle (true = прямое направление, false = обратное)
bool CurrentToggleState { get; }
```

## Примеры использования

### Магнит для сбора предметов

1. Создайте GameObject с компонентом `MagneticField`
2. Установите `Mode` на `Attract`
3. Настройте `Field Strength` и `Radius`
4. Настройте `Affected Layers` (например, только слой "Items")
5. Включите `Use Fixed Update` для стабильности

### Защитное поле (отталкивание)

1. Создайте GameObject с компонентом `MagneticField`
2. Установите `Mode` на `Repel`
3. Настройте силу и радиус
4. Объекты будут отталкиваться от центра поля

### Притягиватель к цели

1. Создайте GameObject с компонентом `MagneticField`
2. Установите `Mode` на `ToTarget`
3. Назначьте `Target Transform` (например, камера игрока)
4. Объекты в радиусе поля (вокруг магнита) будут притягиваться к цели

### Притягиватель к точке

1. Создайте GameObject с компонентом `MagneticField`
2. Установите `Mode` на `ToPoint`
3. Установите `Target Point` (координаты в пространстве)
4. Объекты в радиусе поля (вокруг магнита) будут притягиваться к этой точке

### Притягивание по направлению (Direction)

1. Создайте GameObject с компонентом `MagneticField`
2. Установите `Mode` на `Direction`
3. Задайте `Direction` (например, `(0, 1, 0)` чтобы тянуть вверх)
4. При необходимости включите `Direction Is Local`, чтобы направление следовало за поворотом объекта
5. Объекты в радиусе поля будут получать силу в этом направлении

### Пульсирующее поле (Toggle с любым режимом)

1. Установите любой `Mode` (например, `Attract`, `ToTarget`, `Direction`)
2. Включите галочку **Toggle**
3. Настройте `Attract Duration` и `Repel Duration` (например, 3 секунды в одну сторону, 1 секунда в обратную)
4. Установите `Start With Attract` (с чего начинать)
5. Поле будет автоматически переключать направление с заданными интервалами
6. Используйте событие `OnModeChanged` для реакции на переключение

### Динамическое управление

```csharp
MagneticField field = GetComponent<MagneticField>();
field.SetStrength(20f); // Увеличить силу
field.SetRadius(10f); // Увеличить радиус
field.ToggleMode(); // Переключить режим (Attract/Repel)

// Управление Toggle
field.SetAttractDuration(5f); // Время прямого направления
field.SetRepelDuration(2f); // Время обратного направления
field.ResetToggleTimer(); // Сбросить таймер и начать цикл заново
bool isForward = field.CurrentToggleState; // Проверить текущее направление
```

### Оптимизация производительности

1. Установите `Update Interval` (например, 0.1 секунды)
2. Поле будет обновляться реже, что снизит нагрузку
3. Полезно для полей с большим радиусом

## Визуализация

В режиме редактирования (при выборе объекта) отображается:
- Синяя сфера (прямое направление) или красная сфера (обратное) — радиус поля
- Полупрозрачная сфера — область воздействия
- При включённом Toggle цвет меняется в зависимости от текущего состояния
- В режимах `ToTarget`/`ToPoint` рисуется линия от магнита к цели/точке
- В режиме `Direction` рисуется линия направления и точка на расстоянии `Direction Gizmo Distance`

### Редактирование в сцене

- В режиме `ToPoint` точку можно перемещать прямо в Scene View через handle.
- В режиме `Direction` можно перемещать конец вектора (handle) — направление и длина обновляются автоматически.

## Примечания

- Компонент работает только с 3D физикой
- Рекомендуется использовать `Use Fixed Update` для стабильной физики
- Для объектов без Rigidbody можно включить `Add Rigidbody If Needed`
- Квадратичное затухание создает более естественный эффект
- Объекты автоматически отслеживаются при входе/выходе из поля
- Toggle работает с любым режимом (Attract, Repel, ToTarget, ToPoint, Direction)
- Событие `OnModeChanged` вызывается при переключении Toggle
- Используйте `ResetToggleTimer()` для синхронизации нескольких полей или перезапуска цикла
