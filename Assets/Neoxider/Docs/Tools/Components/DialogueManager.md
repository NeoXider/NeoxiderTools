# Инструмент Dialogue Manager

## 1. Введение

`DialogueManager` — это комплексный инструмент для создания и управления внутриигровыми диалогами. Он использует вложенную структуру данных, что позволяет организовывать сложные повествовательные цепочки с разными персонажами, репликами и изображениями.

Менеджер управляет отображением текста и спрайтов, а также предоставляет множество `UnityEvent`'ов для тонкой настройки и интеграции с другими системами. Новая версия включает в себя опциональный эффект "пишущей машинки" для более живого отображения текста.

---

## 2. Описание класса

### DialogueManager
- **Пространство имен**: `Neo.Tools`
- **Путь к файлу**: `Assets/Neoxider/Scripts/Tools/Components/DialogueManager.cs`

**Описание**
Управляет логикой и отображением диалоговой системы.

### Ключевые особенности
- **Вложенная структура**: Позволяет гибко настраивать диалоги, монологи и отдельные реплики в инспекторе.
- **Эффект "пишущей машинки"**: Опционально отображает текст посимвольно с настраиваемой скоростью.
- **Управление UI**: Автоматически обновляет `TextMeshPro` для имени персонажа и реплик, а также `Image` для спрайта говорящего.
- **Система событий**: Предоставляет `UnityEvent`'ы на каждом уровне (смена диалога, монолога, реплики, персонажа), что дает полный контроль над процессом.
- **Автоматический переход**: Может автоматически начинать следующий монолог после завершения предыдущего.

---

## 3. Настройки в инспекторе

### 3.1. UI Элементы
- `characterImage` (`Image`): UI-элемент для отображения спрайта персонажа.
- `characterNameText` (`TMP_Text`): Текстовое поле для имени персонажа.
- `dialogueText` (`TMP_Text`): Текстовое поле для реплик диалога.
- `setNativeSize` (`bool`): Если `true`, изображение персонажа будет автоматически подгоняться под оригинальный размер спрайта.

### 3.2. Настройки эффектов
- `useTypewriterEffect` (`bool`): Если `true` (по умолчанию), текст будет появляться посимвольно. Если `false`, текст появится мгновенно.
- `charactersPerSecond` (`float`): Скорость появления символов в секунду для эффекта "пишущей машинки".

### 3.3. Поведение
- `autoNextMonolog` (`bool`): Если `true`, следующий монолог начнется автоматически после завершения предыдущего.

### 3.4. Данные диалогов
- `dialogues` (`Dialogue[]`): Основной массив, содержащий все диалоги.

---

## 4. Структура данных: Диалог, Монолог и Реплика

Чтобы понять, как работает компонент, представьте диалог как **матрешку**: одно вложено в другое.

- **Dialogue (Диалог)**: Это самый верхний уровень, вся сцена разговора. Например, "Разговор с кузнецом". В одном `DialogueManager` может быть много разных диалогов (например, для разных квестов).
  - `OnChangeDialog`: Событие, вызываемое в самом начале этого диалога.

- **Monolog (Монолог)**: Это блок реплик, произносимых **одним персонажем подряд**. Как только говорящий меняется, начинается новый монолог. 
  - `characterName`: Имя персонажа, который говорит в этом монологе.
  - `OnChangeMonolog`: Событие, вызываемое в начале этого монолога (например, чтобы камера навелась на говорящего).

- **Sentence (Реплика)**: Это одна порция текста, которая отображается на экране за раз. Длинную речь одного персонажа можно разбить на несколько реплик, чтобы игроку не приходилось читать огромную стену текста. Каждая реплика может иметь свой спрайт.
  - `sentence`: Текст реплики.
  - `sprite`: Изображение персонажа для этой реплики (например, улыбающееся или сердитое лицо).
  - `OnChangeSentence`: Событие, вызываемое при показе этой конкретной реплики.

**Иерархия:** `Dialogue` > `Monolog` > `Sentence`

---

## 5. Пример простого диалога

Давайте создадим короткий диалог между Героем и Кузнецом.

**Диалог:**
1.  **Герой**: "Привет! Мне нужен новый меч."
2.  **Кузнец**: "Привет. Какой именно? У меня есть железные и стальные."
3.  **Кузнец**: (меняется спрайт на задумчивый) "Хотя... для тебя лучше подойдет стальной."
4.  **Герой**: "Отлично, беру!"

**Настройка в инспекторе:**

1.  В поле `dialogues` создаем **1** элемент (`Dialogue`).
2.  Раскрываем его и в поле `monologues` создаем **3** элемента (`Monolog`), так как говорящий меняется 3 раза.

3.  **Настраиваем Монолог 0 (Герой):**
    - `characterName`: "Герой"
    - В `sentences` создаем **1** элемент:
        - `sentence`: "Привет! Мне нужен новый меч."

4.  **Настраиваем Монолог 1 (Кузнец):**
    - `characterName`: "Кузнец"
    - В `sentences` создаем **2** элемента (две реплики подряд от одного персонажа):
        - Элемент 0: `sentence`: "Привет. Какой именно? У меня есть железные и стальные."
        - Элемент 1: `sentence`: "Хотя... для тебя лучше подойдет стальной." (здесь можно добавить другой `sprite`).

5.  **Настраиваем Монолог 2 (Герой):**
    - `characterName`: "Герой"
    - В `sentences` создаем **1** элемент:
        - `sentence`: "Отлично, беру!"

Теперь при запуске этого диалога менеджер последовательно отобразит все реплики, меняя имя персонажа и его спрайты в соответствии с настройками.

---

## 6. Публичные методы

- `StartDialogue(int index, ...)`: Начинает диалог с указанного индекса.
- `NextSentence()`: Переходит к следующей реплике в текущем монологе.
- `NextMonolog()`: Переходит к следующему монологу в текущем диалоге.
- `NextDialogue()`: Переходит к следующему диалогу в массиве.
- `RestartDialogue()`: Начинает текущий диалог заново.

---

## 7. Unity Events (основные)

- `OnSentenceEnd`: Вызывается после отображения каждой реплики.
- `OnMonologEnd`: Вызывается, когда все реплики в монологе закончились.
- `OnDialogueEnd`: Вызывается, когда все монологи в диалоге закончились.
- `OnCharacterChange`: Вызывается при смене говорящего персонажа. Передает `string` (имя нового персонажа).
